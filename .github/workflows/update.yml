name: update-dataset

on:
  schedule:
    # All times are UTC
    - cron: "30 5 * * *"    # ~01:30 ET
    - cron: "30 12 * * *"   # ~08:30 ET
    - cron: "30 17 * * *"   # ~12:30 ET
    - cron: "30 21 * * *"   # ~16:30 ET (extra late-day)
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    defaults:
      run:
        working-directory: ${{ github.workspace }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0            # important: full history
          persist-credentials: true

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install Python deps
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Fetch artifacts
        run: python src/fetch_wordle_data.py

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      # --- RETRYING BUILD STEP ---
      - name: Build dated history from NYT (with retries)
        run: |
          set -e
          tries=0
          until [ $tries -ge 6 ]
          do
            node scripts/fetch_wordle_history.mjs && break
            code=$?
            if [ "$code" -ne 2 ]; then
              echo "Non-retryable error (exit $code)."
              exit $code
            fi
            tries=$((tries+1))
            echo "NYT not live yet (exit 2). Retry $tries/6 after 15m..."
            sleep 900
          done

      # Self-heal: ensure last 3 days are present (idempotent)
      - name: Backfill last 3 days
        run: node scripts/backfill_recent.mjs

      # --- DIAGNOSTICS ---
      - name: Show tail after build (diagnostic)
        run: |
          node -e 'const j=require("./public/used_dated.json"); console.log("TAIL_AFTER_BUILD:", j.results.at(-1), "COUNT:", j.results.length)'

      - name: List changed files (pre-commit)
        run: |
          git status --porcelain
          git diff --name-only

      # --- COMMIT ---
      - name: Configure Git author
        run: |
          git config user.name  "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"

      - name: Commit changes (force add all)
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          commit_message: "chore(data): refresh wordle artifacts [skip ci]"
          branch: ${{ github.ref_name }}
          add_options: "-A"               # <— force stage all changes
          file_pattern: "."               # <— commit any modified file

      - name: Show last commit touching used_dated.json (post-commit)
        run: git log -n 1 -- public/used_dated.json

      # Purge jsDelivr (GET is required) and warm the cache
      - name: Purge jsDelivr caches and warm
        run: |
          set -e
          FILES=("public/used_dated.json" "public/used_first_seen.json" "public/used.json" "public/allowed.json" "public/allowed_not_used.json")
          for f in "${FILES[@]}"; do
            echo "Purging $f ..."
            curl -s "https://purge.jsdelivr.net/gh/willray73-sys/wordle-words@main/$f" || true
            # Warm immediately after purge
            curl -s "https://cdn.jsdelivr.net/gh/willray73-sys/wordle-words@main/$f?warm=$(date +%s)" >/dev/null || true
          done

      - name: Verify jsDelivr tail
        run: |
          node -e 'fetch("https://cdn.jsdelivr.net/gh/willray73-sys/wordle-words@main/public/used_dated.json?nc="+Date.now()).then(r=>r.json()).then(j=>console.log("CDN_TAIL:", j.results.at(-1), "COUNT:", j.results.length)).catch(e=>{console.error(e); process.exit(1);})'
